version: 2

job-configuration: &job-configuration
  working_directory: ~/app
  docker:
    - image: circleci/node:6.10

ssh-keys: &ssh-keys
  fingerprints:
    - "b9:59:21:b0:6b:81:87:c0:e5:ac:80:90:2f:7d:fc:09"

prepare-git: &prepare-git
  name: Preparing git working directory
  command: |
    git clean -d -f
    git checkout -- .
    git config user.name "ci-bot"
    git config user.email "ci-bot@circleci.com"

publish-to-git: &publish-to-git
  name: Publish created version
  command: |
    git push origin $CIRCLE_BRANCH
    git push --tags

jobs:
  install-deps:
    <<: *job-configuration
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "package.json" }}
      - run:
          name: Install local yarn
          command: npm run yarn:install
      - run:
          name: Install dependencies using local yarn
          command: npm run yarn:install-deps
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - ./node_modules
      - persist_to_workspace:
          root: ./
          paths:
            - .git
            - .eslintrc
            - node_modules
            - src
            - package.json
            - webpack.config.js

  test:
    <<: *job-configuration
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Run code checks
          command: npm run lint

  build:
    <<: *job-configuration
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Build application
          command: npm run dist

  release-major:
    <<: *job-configuration
    steps:
      - attach_workspace:
          at: ./
      - add-ssh-keys:
          <<: *ssh-keys
      - run:
          <<: *prepare-git
      - run:
          name: Bump major version
          command: npm version major
      - run:
          <<: *publish-to-git

  release-minor:
    <<: *job-configuration
    steps:
      - attach_workspace:
          at: ./
      - add-ssh-keys:
          <<: *ssh-keys
      - run:
          name: Check ssh key
          command: ssh -T git@github.com
      - run:
          <<: *prepare-git
      - run:
          name: Bump minor version
          command: npm version minor
      - run:
          <<: *publish-to-git

  release-patch:
    <<: *job-configuration
    steps:
      - attach_workspace:
          at: ./
      - add-ssh-keys:
          <<: *ssh-keys
      - run:
          <<: *prepare-git
      - run:
          name: Bump patch version
          command: npm version patch
      - run:
          <<: *publish-to-git

workflows:
  version: 2
  build-test-and-deploy:
    jobs:
      - install-deps
      - test:
          requires:
            - install-deps
      - build:
          requires:
            - install-deps
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
      - approve-major:
          type: approval
          requires:
            - test
          filters:
            branches:
              only: master
      - approve-minor:
          type: approval
          requires:
            - test
          filters:
            branches:
              only: master
      - approve-patch:
          type: approval
          requires:
            - test
          filters:
            branches:
              only: master
      - release-major:
          requires:
            - approve-major
      - release-minor:
          requires:
            - approve-minor
      - release-patch:
          requires:
            - approve-patch
